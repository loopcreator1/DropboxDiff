<html>
<body>
<script src='jquery-1.6.2.min.js'></script>
<script>
function init() {
	diff_plugin.debug = 1;

	// Set up request listener
	chrome.extension.onRequest.addListener(function(request, sender, send_response) {
		var cmd = localStorage.cmd;

		if (!cmd) { return send_response('DropboxDiff is not configured.  See Tools | Extensions to specify a diff tool.') }

		if (!request.left || !request.right) { return }


		chrome.cookies.getAll({domain: '.dropbox.com', name: 'touch'}, function(cookies) {
			var cookie = '';

			$.each(cookies, function(i, c) { cookie += c.name + '=' + c.value + '; ' });

			send_response(
				diff_plugin.diff(
					cookie,
					cmd,
					request.left.url,
					get_file_name(request.left),
					request.right.url,
					get_file_name(request.right)
				)
			);
		});
	});
}

function sanitize_date(d) {
	return d.replace(/[\/:]/g, '.').replace(/ ([AP]M)/, '$1').replace(/^\s+|\s+$/g, '').replace(/\s+\(.+\)/, '').toLowerCase();
}

function get_file_name(info) {
	// Extract filename and revision ("sjid" parameter)
	var rev = info.url.substr(info.url.lastIndexOf('=') + 1);

	var basename = info.url;
	basename = basename.substr(basename.lastIndexOf('/') + 1);
	basename = decodeURIComponent(basename.substr(0, basename.indexOf('?')));

	var dot = basename.lastIndexOf('.');
	var ext = dot == -1 ? '' : basename.substr(dot);
	var base = basename.substr(0, basename.length - ext.length);

	// Append revision to ensure uniqueness
	// Keep extension, in case diff tool can use it
	return sanitize_date(info.changed) + ' ' + base + ' ' + rev + ext;
}
</script>
<object id='diff_plugin' type='application/x-dropbox-diff-plugin'>
	<param name='onload' value='init' />
</object>
</body>
</html>
